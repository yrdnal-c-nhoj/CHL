import React, { useEffect, useState, useMemo } from "react";
import bgVideo from "../../../assets/clocks/26-01-14/kuro.mp4";
import fallbackImg from "../../../assets/clocks/26-01-14/kuro.webp";
import romanFont from '../../../assets/fonts/26-01-14-kuro.otf';

const FONT_NAME = "RomanClockFont";
const CLOCK_GRADIENT = "linear-gradient(180deg, #DCCFE1, #AFB1B3)";

export default function KurosawaClock() {
  const [now, setNow] = useState(new Date());
  const [fontLoaded, setFontLoaded] = useState(false);
  const [videoError, setVideoError] = useState(false);

  useEffect(() => {
    const timer = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    const font = new FontFace(FONT_NAME, `url(${romanFont})`);
    font.load().then((loaded) => {
      document.fonts.add(loaded);
      setFontLoaded(true);
    }).catch(() => setFontLoaded(true));
  }, []);

  // 1. Filter out colons so only digits remain (HHMMSS)
  const digits = useMemo(() => {
    const timeString = now.toLocaleTimeString('en-GB', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
    });
    return timeString.replace(/:/g, "").split("");
  }, [now]);

  const styles = {
    wrapper: {
      height: "100dvh",
      width: "100dvw",
      overflow: "hidden",
      position: "relative",
      backgroundColor: "#000",
    },
    media: {
      position: "absolute",
      top: 0,
      left: 0,
      width: "100%",
      height: "100%",
      objectFit: "cover",
      zIndex: 0,
    },
    container: {
      position: "absolute",
      top: "-2dvh",
      left: "50%",
      transform: "translate(-50%, 0)",
      display: "flex",
      gap: "0", // 2. Ensure no gap between flex items
      zIndex: 5,
      pointerEvents: "none",
    },
    digit: {
      // 3. Adjust width to match the font's visual footprint 
      // Note: You may need to tweak this 10dvh to 12dvh depending on the font's kerning
      width: "8dvh", 
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
      fontFamily: `${FONT_NAME}, sans-serif`,
      fontSize: "10dvh",
      background: CLOCK_GRADIENT,
      WebkitBackgroundClip: "text",
      WebkitTextFillColor: "transparent",
      textAlign: "center",
    }
  };

  return (
    <main style={styles.wrapper} aria-label={now.toLocaleTimeString()}>
      {!videoError ? (
        <video
          src={bgVideo}
          muted autoPlay loop playsInline
          onError={() => setVideoError(true)}
          style={styles.media}
        />
      ) : (
        <img src={fallbackImg} alt="" style={styles.media} />
      )}

      {fontLoaded && (
        <div style={styles.container} aria-hidden="true">
          {digits.map((digit, index) => (
            <div key={`${index}-${digit}`} style={styles.digit}>
              {digit}
            </div>
          ))}
        </div>
      )}
    </main>
  );
}
